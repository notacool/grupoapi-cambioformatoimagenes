#!/usr/bin/env python3
"""
Test de Integraci√≥n con Archivos Reales
========================================

Este test verifica el flujo completo del sistema usando archivos TIFF reales:
1. Configuraci√≥n y validaci√≥n
2. Procesamiento de archivos TIFF reales
3. Conversi√≥n a m√∫ltiples formatos
4. Postconversi√≥n (PDF consolidado y MET)
5. Validaci√≥n de salidas

Autor: Sistema de Automatizaci√≥n y Digitalizaci√≥n
Fecha: 2024
"""

import sys
import tempfile
import shutil
from pathlib import Path
from typing import Dict, List, Any
import time

# Agregar el directorio src al path
sys.path.insert(0, str(Path(__file__).parent / 'src'))

from src.converter import TIFFConverter
from src.config_manager import ConfigManager
from src.file_processor import FileProcessor
from src.output_manager import output_manager


class RealIntegrationTest:
    """Test de integraci√≥n con archivos reales"""
    
    def __init__(self):
        self.test_dir = None
        self.input_dir = None
        self.output_dir = None
        self.config_manager = None
        self.tiff_converter = None
        self.file_processor = None
        
    def setup_test_environment(self) -> bool:
        """Configura el entorno de prueba con archivos reales"""
        try:
            # Crear directorio temporal
            self.test_dir = Path(tempfile.mkdtemp(prefix="real_integration_test_"))
            self.input_dir = self.test_dir / "input"
            self.output_dir = self.test_dir / "output"
            
            # Crear directorios
            self.input_dir.mkdir(parents=True, exist_ok=True)
            self.output_dir.mkdir(parents=True, exist_ok=True)
            
            # Buscar archivos TIFF reales en el proyecto
            real_tiff_files = []
            
            # Buscar en test_input
            test_input_dir = Path("test_input")
            if test_input_dir.exists():
                real_tiff_files.extend(list(test_input_dir.glob("**/*.tiff")))
            
            # Buscar en test_outputs
            test_outputs_dir = Path("test_outputs")
            if test_outputs_dir.exists():
                real_tiff_files.extend(list(test_outputs_dir.glob("**/*.tiff")))
            
            # Buscar en el directorio ra√≠z
            real_tiff_files.extend(list(Path(".").glob("*.tiff")))
            
            if not real_tiff_files:
                output_manager.warning("‚ö†Ô∏è No se encontraron archivos TIFF reales para el test")
                return False
            
            # Crear subcarpeta de prueba
            subfolder = self.input_dir / "test_subfolder"
            subfolder.mkdir(exist_ok=True)
            
            # Crear carpeta TIFF
            tiff_dir = subfolder / "TIFF"
            tiff_dir.mkdir(exist_ok=True)
            
            # Copiar archivos TIFF reales (m√°ximo 3 para el test)
            copied_files = 0
            for tiff_file in real_tiff_files[:3]:  # Limitar a 3 archivos
                if tiff_file.exists() and tiff_file.stat().st_size > 0:
                    dest_file = tiff_dir / f"test_{copied_files:02d}.tiff"
                    shutil.copy2(tiff_file, dest_file)
                    output_manager.info(f"‚úÖ Archivo TIFF real copiado: {tiff_file.name} -> {dest_file.name}")
                    copied_files += 1
            
            if copied_files == 0:
                output_manager.warning("‚ö†Ô∏è No se pudieron copiar archivos TIFF v√°lidos")
                return False
            
            output_manager.success(f"‚úÖ Entorno de prueba configurado con {copied_files} archivos TIFF reales")
            output_manager.info(f"üìÅ Directorio de prueba: {self.test_dir}")
            return True
            
        except Exception as e:
            output_manager.error(f"‚ùå Error configurando entorno de prueba: {str(e)}")
            return False
    
    def test_configuration(self) -> bool:
        """Test de configuraci√≥n del sistema"""
        try:
            output_manager.info("üîß Probando configuraci√≥n del sistema...")
            
            # Inicializar config manager
            self.config_manager = ConfigManager("config.yaml")
            
            # Verificar configuraci√≥n
            assert self.config_manager is not None, "ConfigManager no inicializado"
            
            # Verificar formatos habilitados
            enabled_formats = self.config_manager.get_enabled_formats()
            output_manager.info(f"üìã Formatos habilitados: {enabled_formats}")
            
            # Verificar que hay al menos un formato habilitado
            assert len(enabled_formats) > 0, "No hay formatos habilitados"
            
            output_manager.success("‚úÖ Configuraci√≥n del sistema validada")
            return True
            
        except Exception as e:
            output_manager.error(f"‚ùå Error en test de configuraci√≥n: {str(e)}")
            return False
    
    def test_conversion(self) -> bool:
        """Test de conversi√≥n con archivos reales"""
        try:
            output_manager.info("üîÑ Probando conversi√≥n con archivos reales...")
            
            # Inicializar converter
            self.tiff_converter = TIFFConverter()
            
            # Verificar que hay archivos TIFF para procesar
            files_to_process = list(self.input_dir.glob("**/*.tiff"))
            assert len(files_to_process) > 0, "No hay archivos TIFF para procesar"
            
            output_manager.info(f"üìã Archivos TIFF encontrados: {len(files_to_process)}")
            
            # Mostrar informaci√≥n de los archivos
            for file_path in files_to_process:
                size_mb = file_path.stat().st_size / (1024 * 1024)
                output_manager.info(f"üìÑ {file_path.name}: {size_mb:.2f} MB")
            
            # Convertir directorio completo
            output_manager.info("üîÑ Ejecutando conversi√≥n completa...")
            start_time = time.time()
            
            result = self.tiff_converter.convert_directory(str(self.input_dir), str(self.output_dir))
            
            end_time = time.time()
            conversion_time = end_time - start_time
            
            # Verificar resultado
            assert result is not None, "Conversi√≥n fall√≥"
            assert result.get("success", False), "Conversi√≥n no exitosa"
            
            # Verificar que se generaron archivos de salida
            output_files = list(self.output_dir.glob("**/*"))
            output_files = [f for f in output_files if f.is_file()]
            assert len(output_files) > 0, "No se generaron archivos de salida"
            
            output_manager.info(f"üìã Archivos de salida generados: {len(output_files)}")
            output_manager.info(f"‚è±Ô∏è Tiempo de conversi√≥n: {conversion_time:.2f} segundos")
            
            # Mostrar informaci√≥n de archivos generados
            for output_file in output_files:
                size_mb = output_file.stat().st_size / (1024 * 1024)
                output_manager.info(f"üìÑ {output_file.name}: {size_mb:.2f} MB")
            
            output_manager.success("‚úÖ Conversi√≥n con archivos reales validada")
            return True
            
        except Exception as e:
            output_manager.error(f"‚ùå Error en test de conversi√≥n: {str(e)}")
            return False
    
    def test_output_validation(self) -> bool:
        """Test de validaci√≥n de salidas"""
        try:
            output_manager.info("üìÑ Probando validaci√≥n de salidas...")
            
            # Verificar archivos PDF
            pdf_files = list(self.output_dir.glob("**/*.pdf"))
            if pdf_files:
                output_manager.info(f"üìã Archivos PDF encontrados: {len(pdf_files)}")
                for pdf_file in pdf_files:
                    assert pdf_file.stat().st_size > 0, f"PDF vac√≠o: {pdf_file.name}"
                    output_manager.info(f"‚úÖ PDF v√°lido: {pdf_file.name}")
            
            # Verificar archivos JPG
            jpg_files = list(self.output_dir.glob("**/*.jpg"))
            if jpg_files:
                output_manager.info(f"üìã Archivos JPG encontrados: {len(jpg_files)}")
                for jpg_file in jpg_files:
                    assert jpg_file.stat().st_size > 0, f"JPG vac√≠o: {jpg_file.name}"
                    output_manager.info(f"‚úÖ JPG v√°lido: {jpg_file.name}")
            
            # Verificar archivos MET
            met_files = list(self.output_dir.glob("**/*.xml"))
            if met_files:
                output_manager.info(f"üìã Archivos MET encontrados: {len(met_files)}")
                for met_file in met_files:
                    assert met_file.stat().st_size > 0, f"MET vac√≠o: {met_file.name}"
                    output_manager.info(f"‚úÖ MET v√°lido: {met_file.name}")
            
            # Verificar archivos de log
            log_files = list(self.output_dir.glob("**/*.log"))
            if log_files:
                output_manager.info(f"üìã Archivos de log encontrados: {len(log_files)}")
                for log_file in log_files:
                    assert log_file.stat().st_size > 0, f"Log vac√≠o: {log_file.name}"
                    output_manager.info(f"‚úÖ Log v√°lido: {log_file.name}")
            
            output_manager.success("‚úÖ Validaci√≥n de salidas completada")
            return True
            
        except Exception as e:
            output_manager.error(f"‚ùå Error en test de validaci√≥n: {str(e)}")
            return False
    
    def test_performance(self) -> bool:
        """Test de rendimiento"""
        try:
            output_manager.info("‚ö° Probando rendimiento...")
            
            # Calcular estad√≠sticas de rendimiento
            input_files = list(self.input_dir.glob("**/*.tiff"))
            output_files = list(self.output_dir.glob("**/*"))
            output_files = [f for f in output_files if f.is_file()]
            
            # Calcular tama√±os
            total_input_size = sum(f.stat().st_size for f in input_files)
            total_output_size = sum(f.stat().st_size for f in output_files)
            
            input_size_mb = total_input_size / (1024 * 1024)
            output_size_mb = total_output_size / (1024 * 1024)
            
            # Calcular ratio de compresi√≥n
            if total_input_size > 0:
                compression_ratio = (total_output_size / total_input_size) * 100
            else:
                compression_ratio = 0
            
            output_manager.info(f"üìä Estad√≠sticas de rendimiento:")
            output_manager.info(f"   üì• Tama√±o de entrada: {input_size_mb:.2f} MB")
            output_manager.info(f"   üì§ Tama√±o de salida: {output_size_mb:.2f} MB")
            output_manager.info(f"   üìà Ratio de compresi√≥n: {compression_ratio:.1f}%")
            output_manager.info(f"   üìÅ Archivos de entrada: {len(input_files)}")
            output_manager.info(f"   üìÅ Archivos de salida: {len(output_files)}")
            
            output_manager.success("‚úÖ Test de rendimiento completado")
            return True
            
        except Exception as e:
            output_manager.error(f"‚ùå Error en test de rendimiento: {str(e)}")
            return False
    
    def cleanup(self):
        """Limpia el entorno de prueba"""
        try:
            if self.test_dir and self.test_dir.exists():
                shutil.rmtree(self.test_dir)
                output_manager.info(f"üßπ Entorno de prueba limpiado: {self.test_dir}")
        except Exception as e:
            output_manager.warning(f"‚ö†Ô∏è Error limpiando entorno: {str(e)}")
    
    def run_complete_test(self) -> bool:
        """Ejecuta el test de integraci√≥n con archivos reales"""
        try:
            output_manager.info("üöÄ Iniciando test de integraci√≥n con archivos reales...")
            start_time = time.time()
            
            # Configurar entorno
            if not self.setup_test_environment():
                output_manager.warning("‚ö†Ô∏è No se pudo configurar el entorno con archivos reales")
                return False
            
            # Ejecutar tests
            tests = [
                ("Configuraci√≥n", self.test_configuration),
                ("Conversi√≥n", self.test_conversion),
                ("Validaci√≥n de Salidas", self.test_output_validation),
                ("Rendimiento", self.test_performance)
            ]
            
            passed_tests = 0
            total_tests = len(tests)
            
            for test_name, test_func in tests:
                output_manager.info(f"üß™ Ejecutando test: {test_name}")
                if test_func():
                    passed_tests += 1
                    output_manager.success(f"‚úÖ Test {test_name} PAS√ì")
                else:
                    output_manager.error(f"‚ùå Test {test_name} FALL√ì")
            
            # Calcular tiempo total
            end_time = time.time()
            total_time = end_time - start_time
            
            # Mostrar resultados
            output_manager.info("=" * 60)
            output_manager.info("üìä RESULTADOS DEL TEST DE INTEGRACI√ìN CON ARCHIVOS REALES")
            output_manager.info("=" * 60)
            output_manager.info(f"‚úÖ Tests pasados: {passed_tests}/{total_tests}")
            output_manager.info(f"‚è±Ô∏è Tiempo total: {total_time:.2f} segundos")
            
            if passed_tests == total_tests:
                output_manager.success("üéâ ¬°TODOS LOS TESTS PASARON!")
                return True
            else:
                output_manager.error(f"‚ùå {total_tests - passed_tests} tests fallaron")
                return False
                
        except Exception as e:
            output_manager.error(f"‚ùå Error en test de integraci√≥n: {str(e)}")
            return False
        finally:
            self.cleanup()


def main():
    """Funci√≥n principal"""
    try:
        output_manager.info("üß™ Test de Integraci√≥n con Archivos Reales")
        output_manager.info("=" * 60)
        
        # Crear y ejecutar test
        integration_test = RealIntegrationTest()
        success = integration_test.run_complete_test()
        
        if success:
            output_manager.success("üéâ ¬°TEST DE INTEGRACI√ìN CON ARCHIVOS REALES COMPLETADO EXITOSAMENTE!")
            sys.exit(0)
        else:
            output_manager.error("‚ùå TEST DE INTEGRACI√ìN CON ARCHIVOS REALES FALL√ì")
            sys.exit(1)
            
    except Exception as e:
        output_manager.error(f"‚ùå Error cr√≠tico: {str(e)}")
        sys.exit(1)


if __name__ == "__main__":
    main()
